var d=Object.create;var l=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,b=Object.prototype.hasOwnProperty;var E=t=>l(t,"__esModule",{value:!0});var v=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of m(e))!b.call(t,s)&&(r||s!=="default")&&l(t,s,{get:()=>e[s],enumerable:!(o=g(e,s))||o.enumerable});return t},D=(t,e)=>v(E(l(t!=null?d(_(t)):{},"default",!e&&t&&t.__esModule?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var k=D(require("axios"));var u=require("process"),C="LOGVERSION 3";function w(t){global.main=async e=>{try{var r=await t(e)}catch(n){return console.log(n),console.log("SUCCEEDED false"),console.log(`MEMORY ${u.memoryUsage().rss}`),{statusCode:500,body:"Internal Server Error"}}var o=r.statusCode||200,s={statusCode:o,headers:r.headers,body:r.body};return console.log(C),console.log(`SUCCEEDED ${o>=200&&o<300}`),console.log(`MEMORY ${u.memoryUsage().rss}`),s}}var S=require("axios").default,h=class{constructor(e){if("error"in e)throw new Error(e.error);if("access_token"in e)this.access_token=e.access_token;else throw new Error("No access token present in token");if("refresh_token"in e)this.refresh_token=e.refresh_token;else throw new Error("No refresh token present in token");if("expiry"in e)this.expiry=new Date(e.expiry);else{var r=new Date;"expires_in"in e?r.setHours(r.getHours()+e.expires_in/3600):r.setHours(r.getHours()+1),this.expiry=r}if("termination"in e)this.termination=new Date(e.termination);else{var o=new Date;o.setHours(o.getHours()+90*24),this.termination=o}}async refresh(e,r){var o=await S.post("https://student.sbhs.net.au/api/token",new URLSearchParams({refresh_token:this.refresh_token,grant_type:"refresh_token",client_id:e,client_secret:r}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}),s=o.data;if("error"in s)throw new Error(s.error);if("access_token"in s)this.access_token=s.access_token;else throw new Error("No access token present in token");if("expiry"in s)this.expiry=new Date(s.expiry);else{var n=new Date;n.setHours(n.getHours()+1),this.expiry=n}}};var p={"dailynews/list.json":"announcements","timetable/daytimetable.json":"dailytimetable","timetable/timetable.json":"timetable","details/userinfo.json":"userinfo"};async function f(t,e){var r=await k.default.get(`https://student.sbhs.net.au/api/${t}`,{headers:{Authorization:`Bearer ${e.access_token}`}});return r.data}w(async t=>{if(!t.token)return{statusCode:400,body:"You must provide a token"};var e=new h(JSON.parse(t.token));if(new Date>e.termination)return{statusCode:422,body:"Token is terminated"};new Date>e.expiry&&await e.refresh(t.client_id,t.client_secret);var r={result:{},token:e},o=[];Object.keys(p).forEach(c=>{o.push(f(c,e).then(y=>{r.result[p[c]]=y}))});var s=new Date,n=s.getFullYear().toString(),a=(s.getMonth()+1).toString(),i=(s.getDate()+1).toString();return a<10&&(a=`0${a}`),i<10&&(i=`0${i}`),o.push(f(`timetable/daytimetable.json?date=${n}-${a}-${i}`,e).then(c=>{r.result["next-dailytimetable"]=c})),await Promise.all(o),{body:r}});
