var _=Object.create;var a=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var b=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var v=t=>a(t,"__esModule",{value:!0});var E=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of f(e))!m.call(t,s)&&(r||s!=="default")&&a(t,s,{get:()=>e[s],enumerable:!(n=d(e,s))||n.enumerable});return t},D=(t,e)=>E(v(a(t!=null?_(b(t)):{},"default",!e&&t&&t.__esModule?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var w=D(require("axios"));var u=require("process"),x="LOGVERSION 3";function g(t){global.main=async e=>{e.__ow_body!==void 0&&e.__ow_body!==null&&(e=Object.assign(JSON.parse(e.__ow_body),e));try{var r=await t(e)}catch(o){return console.log(o),console.log("SUCCEEDED false"),console.log(`MEMORY ${u.memoryUsage().rss}`),{statusCode:500,body:"Internal Server Error"}}var n=r.statusCode||200,s={statusCode:n,body:r.body};return console.log(x),console.log(`SUCCEEDED ${n>=200&&n<300}`),console.log(`MEMORY ${u.memoryUsage().rss}`),s}}var C=require("axios").default,c=class{constructor(e){if("error"in e)throw new Error(e.error);if("access_token"in e)this.access_token=e.access_token;else throw new Error("No access token present in token");if("refresh_token"in e)this.refresh_token=e.refresh_token;else throw new Error("No refresh token present in token");if("expiry"in e)this.expiry=new Date(e.expiry);else{var r=new Date;"expires_in"in e?r.setHours(r.getHours()+e.expires_in/3600):r.setHours(r.getHours()+1),this.expiry=r}if("termination"in e)this.termination=new Date(e.termination);else{var n=new Date;n.setHours(n.getHours()+90*24),this.termination=n}}async refresh(e,r){var n=await C.post("https://student.sbhs.net.au/api/token",new URLSearchParams({refresh_token:this.refresh_token,grant_type:"refresh_token",client_id:e,client_secret:r}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}),s=n.data;if("error"in s)throw new Error(s.error);if("access_token"in s)this.access_token=s.access_token;else throw new Error("No access token present in token");if("expiry"in s)this.expiry=new Date(s.expiry);else{var o=new Date;o.setHours(o.getHours()+1),this.expiry=o}}};var k={"dailynews/list.json":"announcements","timetable/daytimetable.json":"dailytimetable","timetable/timetable.json":"timetable","details/userinfo.json":"userinfo"};async function y(t,e){var r=await w.default.get(`https://student.sbhs.net.au/api/${t}`,{headers:{Authorization:`Bearer ${e.access_token}`}});return r.data}g(async t=>{if(!t.token)return{statusCode:400,body:"You must provide a token"};var e=new c(JSON.parse(t.token));if(new Date>e.termination)return{statusCode:422,body:"Token is terminated"};new Date>e.expiry&&await e.refresh(t.client_id,t.client_secret);var r={result:{},token:e},n=[];Object.keys(k).forEach(i=>{n.push(y(i,e).then(p=>{r.result[k[i]]=p}))});var s=new Date,o=s.getFullYear().toString();if(s.getMonth()+1<10)var l=`0${s.getMonth()+1}`;else var l=(s.getMonth()+1).toString();if(s.getDate()+1<10)var h=`0${s.getDate()+1}`;else var h=(s.getDate()+1).toString();return n.push(y(`timetable/daytimetable.json?date=${o}-${l}-${h}`,e).then(i=>{r.result["next-dailytimetable"]=i})),await Promise.all(n),{body:r}});
